################################################################################
# VORON 2.4  350mm  打印机配置文件
################################################################################
# COPYRIGHT © 2021 - 2025  Samuel Wang
# 本文件可以根据GNU GPLv3许可协议进行分发
# This file may be distributed under the terms of the GNU GPLv3 license
################################################################################
# Discord: Samuel-0-0#0576    Github: Samuel-0-0    Bilibili: Samuel-0_0
################################################################################
# 文件用途：喷嘴耗材清理
################################################################################
# 根据你的实际情况编辑此文件
################################################################################
#
# 更多信息请参见 https://github.com/Graylag-PD/Goose-Belt-Purger
#
# 配置文件版本: 0.7.2 (20250822)

######################################################
## 皮带引脚定义
######################################################
[output_pin goose_belt]
# 将'pin:'定义为你的控制板引脚。不要更改下面的其他行
pin: PD15
pwm: True
hardware_pwm: True
cycle_time: 0.00004   # 25kHz PWM

######################################################
## 宏
######################################################
[gcode_macro GOOSE_PURGE]
description: 鹅子皮带清理例程。调用时使用参数 PURGE_LENGTH 或 PURGE_VOLUME 来设置所需清理体积(以 mm 或 mm^3 为单位) 
            # 注意: 参数 LENGTH 和 VOLUME 仍然可用，但已弃用并将在未来版本中移除
# ===参数===
# 参数按阶段顺序排列，每个阶段的功能在其部分说明

#############
# 通用
#############
    # 耗材直径(mm)。用于将清理体积转换为清理长度。有效范围为 <1.0 .. 4.0>
variable_filament_diameter: 1.75

#############
# 阶段0: 预备
#############
# 打印头移动到一个安全位置，从该位置可以到达清理皮带
#________________________
    # True 表示清理将先移动到预备点开始。False 表示打印头将直接到达清理位置
    # 当你确定总是从安全点调用清理时可禁用此选项。这通常适用于MMU，因为你会先停放再换耗材
variable_start_with_stage: True
    # 打印头在到达清理位置前应去的位置？应是可以无碰撞到达的安全点，并且从该点能到达清理位置
variable_x_stage: 172
variable_y_stage: 250
variable_z_stage: False    # 如果你使用龙门架安装的清理器且不需要Z轴移动，请设为'False'。如果需要Z轴移动(如V2.4机架安装)，请输入数值
    # 移动到清理前预备点的速度(mm/s)
variable_th_to_stage: 50

#############
# 阶段1: 移动到清理位置
#############
# 打印头移动到清理位置并激活皮带
#________________________
    # 清理时打印头应去的位置
variable_x_purge: 172
variable_y_purge: 255
variable_z_purge: False    # 如果你使用龙门架安装的清理器且不需要Z轴移动，请设为'False'。如果需要Z轴移动(如V2.4机架安装)，请输入数值
    # 移动到清理位置的速度(mm/s)，清理结束后返回预备点时也使用该速度
variable_th_to_purge: 20
    # 驱动皮带的速度(PWM占空比)，取值范围0.0~1.0
variable_belt_pwm: 0.25
    # 风扇控制:
    # 在清理期间开启或关闭风扇可能有助于耗材附着或从皮带上分离。清理宏可保存当前风扇设置，在清理期间覆盖它，结束后自动恢复
    # 此变量控制宏是否接管风扇。False 表示风扇不被覆盖
variable_control_fan: True
    # 清理过程中的风扇速度。取值范围0.0~1.0。注意，若打印对气流敏感的材料，风扇过大会对打印产生负面影响
variable_fan_speed: 0.0

#############
# 阶段2a: 清理
#############
# 单个清理段。如果未达到总清理体积，则进入阶段2b: 停顿；若已完成则进入阶段3: 收尾
#________________________
    # 清理时的挤出速度(mm/s)
variable_extrusion_fr: 5
  # 回抽速度(mm/s)
variable_retraction_fr: 30
  # 取消回抽速度(mm/s)
variable_deretraction_fr: 30
  # 清理体积分割为多个短段，以保证废料大小可控。每段后都会回抽。宏会自动调整段长以尽量减少浪费
    # 最小挤出长度(mm)
variable_extrusion_min: 20
    # 最大挤出长度(mm)
variable_extrusion_max: 30
    # 回抽长度(mm)
variable_retraction: 2
    # 是否将最后一段凑整？最后一段通常比前面短。凑整有助于废料清理，但会增加耗材消耗
    # 第一段始终至少 extrusion_min
variable_roundup: True
    # 如果未传入参数，使用的默认清理体积(mm3)
variable_default_purge_volume: 0


#############
# 阶段2b: 停顿
#############
# 在清理段之间停顿。作用是物理分隔清理段。随后取消回抽并返回阶段2a
#________________________
    # 回抽与取消回抽之间的停顿时间(毫秒)
variable_rtr_dwell: 100
    # 停顿期间皮带速度。通常100%PWM(1.0)以缩短停顿时间。设为-1表示保持正常清理速度
variable_belt_pwm_dwell: 1.0
    # 皮带减速额外等待时间。如果系统惯量低(皮带最高速低)，可设为0。若停顿期间更改了皮带速度则需要此参数
variable_slowdown_dwell: 100
    # 取消回抽长度(mm)
variable_deretraction: 2

#############
# 阶段3: 收尾
#############
# 清理宏的结束步骤，如关闭电机
#________________________
    # 最终回抽长度(mm)。在最后一次挤出结束时执行。可以与常规回抽不同。增大此值可减少耗材拉丝，但如果打印开始时不进行回抽恢复（或预挤出），可能会导致打印缺口。  
variable_final_retraction: 2
  # 最终回抽的进给速度(mm/s)  
variable_final_retraction_fr: 30
    # 是否以阶段结束？如果为True，清除拉丝的最后动作将回到停放点（参见阶段0）。如果为False，则跳过停放，直接进入打印移动。  
    # 通常可以禁用以节省时间并减少滴料
variable_end_with_stage: True
    # 清理结束后是否恢复Z坐标？对机架安装的清理器有用。通过G1命令直接修改Z
    # 如果不需要Z轴移动(如Trident或龙门架安装的V2.4)，请设为False
variable_restore_z: False
    # 恢复Z时使用的速度(mm/s)。当restore_z为False时忽略
variable_th_z_restore: 10
    # 清理结束后皮带停止的延迟时间(秒)。用于清理皮带上残余物
variable_time_belt_stop: 16
    # 收尾阶段皮带速度。通常100%PWM(1.0)以缩短清理。设为-1表示保持正常清理速度
variable_belt_pwm_end: 1.0
    # 清理宏结束时调用的用户脚本。例如调用毛刷擦拭。设为''表示不调用任何东西
variable_user_end_script: ''



### 请勿修改此处之后的内容 ###

# ===代码=== 
gcode:

            # 单个清理段的例程。对剩余段递归调用
    {% macro purge_segment(length_remaining) %}
          {% if length_remaining > 0 %}
            # 接近请求的清理长度时执行
            {% if length_remaining <= extrusion_segment %}
                {% if roundup %}
                    {% if length_remaining < extrusion_min %}
                        G1 E{extrusion_min} F{extrusion_fr*60}
                    {% else %}
                        G1 E{extrusion_segment} F{extrusion_fr*60}
                    {% endif %}
                {% else %}
                    G1 E{length_remaining} F{extrusion_fr*60}
                {% endif %}
                G1 E{(-final_retraction)} F{final_retraction_fr*60}
            {% else %}
            # 正常清理段
                G1 E{extrusion_segment} F{extrusion_fr*60}
                G1 E{(-retraction)} F{retraction_fr*60}
                # 停顿。在此之前和之后调整皮带速度
                {% if belt_pwm_dwell >= 0 %}
                    SET_PIN PIN=goose_belt VALUE={belt_pwm_dwell}
                {% endif %}
                G4 P{rtr_dwell}
                {% if belt_pwm_dwell >= 0 %}
                    SET_PIN PIN=goose_belt VALUE={belt_pwm}
                    G4 P{slowdown_dwell}
                {% endif %}
                # 取消回抽
                G1 E{deretraction} F{deretraction_fr*60}
                # 递归
                {purge_segment(length_remaining - extrusion_segment)}
            {% endif %}
        {% endif %}
    {% endmacro %}
    
    # 读取参数
    {% set purge_volume = params.PURGE_VOLUME|default(0)|float %}
    {% set purge_length = params.PURGE_LENGTH|default(0)|float %}

    # 以下是旧参数，将来会被移除
    {% set volume = params.VOLUME|default(0)|float %}
    {% set length = params.LENGTH|default(0)|float %}
    # 弃用提示 - 通知用户不要再使用这些参数
    {% if ((length != 0) or (volume !=0)) %}
        M118 参数 LENGTH 和 VOLUME 已弃用，将在未来版本中移除。请使用 PURGE_LENGTH 和 PURGE_VOLUME。
    {% endif %}
    # 旧参数转换
    {% if ((purge_length == 0) and (length != 0)) %}
        {% set purge_length = length %}
    {% endif %}
    {% if ((purge_volume == 0) and (volume != 0)) %}
        {% set purge_volume = volume %}
    {% endif %}

    # 检查是否传入了purge_volume，如果没有则使用默认值
    # 注意，我们在健壮性检查之前执行，以便处理用户输入的负默认值。这也允许通过传入负PURGE_VOLUME或者PURGE_LENGTH来覆盖默认值为零
    {% if purge_volume == 0 %}
        {% set purge_volume = default_purge_volume %}
    {% endif %}
        
    # 针对错误输入的健壮性检查
    {% if purge_volume < 0 %}
        {% set purge_volume = 0 %}
    {% endif %}
    {% if purge_length < 0 %}
        {% set purge_length = 0 %}
        {% set purge_volume = 0 %}
    {% endif %}
    {% if extrusion_max <= 0 %}
        M118 变量'extrusion_max'必须为正数，已覆盖为30 mm
        {% set extrusion_max = 30 %}
    {% endif %}
    {% if ((extrusion_min > extrusion_max) or (extrusion_min < 0)) %}
        M118 变量'extrusion_min'必须在<0..'extrusion_max'>范围内，已覆盖为'extrusion_max'
        {% set extrusion_min = extrusion_max %}
    {% endif %}
    {% if ((filament_diameter < 1) or (filament_diameter > 4)) %}
        M118 耗材直径超出范围，已按默认1.75 mm计算
        {% set filment_diameter = 1.75 %}
    {% endif %}
    
    # 若未提供purge_length，则由体积计算长度；若已提供，则计算purge_volume备用
    {% if purge_length == 0 %}
        {% set purge_length = purge_volume/(3.1415926*filament_diameter*filament_diameter/4) %}
    {% else %}
        {% set purge_volume = purge_length*(3.1415926*filament_diameter*filament_diameter/4) %}
    {% endif %}
    
    # 计算实际挤出段
    {% set segments = (purge_length / extrusion_max)|round(0, 'ceil')|int %}
    {% if segments > 0 %}
        {% set extrusion_segment = purge_length|float / segments %}
    {% else %}   # 仅当purge_length为0时才会发生
        {% set extrusion_segment = extrusion_min %}
    {% endif %}
    {% if extrusion_segment < extrusion_min %}
        {% set extrusion_segment = extrusion_min %}
    {% endif %}
    
    # 处理Z坐标
    {% if z_stage == False %}
        {% set z_stage = printer.toolhead.position.z %}
    {% endif %}
    {% if z_purge == False %}
        {% set z_purge = printer.toolhead.position.z %}
    {% endif %}
    {% if restore_z == True %}
        {% set original_z = printer.toolhead.position.z %}
    {% endif %}
        
    #
    UPDATE_DELAYED_GCODE ID=_goose_belt_timer DURATION=0
    SAVE_GCODE_STATE NAME=goose_purge_state
    G90
    M83

       # 报告清理开始
    M118 开始清理。请求清理 {purge_length|round(1, 'common')} mm ({purge_volume|round(1, 'common')} mm3) 耗材

    
        # 移动到预备点
    {% if start_with_stage == True %}
        G1 X{x_stage} Y{y_stage} Z{z_stage} F{th_to_stage*60}
    {% endif %}
        # 启动皮带
    SET_PIN PIN=goose_belt VALUE={belt_pwm}
        # 风扇逻辑
    {% if control_fan == True %}
        {% set fan_speed_before_purge = printer.fan.speed * 255 %}
        M106 S{fan_speed * 255}
    {% endif %}    
        # 移动到清理位置
    G1 X{x_purge} Y{y_purge} Z{z_purge} F{th_to_purge*60}

        # 清理循环   
    {purge_segment(purge_length)}
        
        # 调用延时宏停止皮带，或立即停止
    {% if time_belt_stop <= 0 %}
        SET_PIN PIN=goose_belt VALUE=0
    {% else %}
        {% if belt_pwm_dwell >= 0 %}
            SET_PIN PIN=goose_belt VALUE={belt_pwm_end}
        {% endif %}
        UPDATE_DELAYED_GCODE ID=_goose_belt_timer DURATION={time_belt_stop}
    {% endif %}

        # 风扇逻辑
    {% if control_fan == True %}
        M106 S{fan_speed_before_purge}
    {% endif %}    
    
        # 返回预备点
    {% if end_with_stage == True %}
        G1 X{x_stage} Y{y_stage} Z{z_stage} F{th_to_purge*60}
    {% endif %}
    
        # 如有需要恢复Z
    {% if restore_z == True %}
        G1 Z{original_z} F{th_z_restore*60}
    {% endif %}
    
        # 用户结束脚本
    { user_end_script }
    
        # 报告实际清理的耗材
    {% if roundup == True %}
        M118 清理完成！清理了 {(extrusion_segment*segments)|round(1, 'common')} mm ({((extrusion_segment*segments)*3.1415926*filament_diameter*filament_diameter/4)|round(1, 'common')} mm3) 耗材，共 {segments} 段。凑整已启用。
    {% else %}
        {% if ((purge_length > 0) and (purge_length < extrusion_min)) %}
            M118 清理完成！清理了 {(extrusion_segment)|round(1, 'common')} mm ({((extrusion_segment)*3.1415926*filament_diameter*filament_diameter/4)|round(1, 'common')} mm3) 耗材，共1段。因变量'extrusion_min'覆盖。
        {% else %}
            M118 清理完成！清理了 {(purge_length)|round(1, 'common')} mm ({purge_volume|round(1, 'common')} mm3) 耗材，共 {segments} 段。 
        {% endif %}
    {% endif %}
    

    RESTORE_GCODE_STATE NAME=goose_purge_state
    
    
    
[delayed_gcode _goose_belt_timer]
gcode:
    
    SET_PIN PIN=goose_belt VALUE=0    
   
[gcode_macro _goose_purge_hh]
gcode:
   GOOSE_PURGE PURGE_VOLUME={printer.mmu.toolchange_purge_volume}
