################################################################################
# VORON 2.4  350mm  打印机配置文件
################################################################################
# COPYRIGHT © 2021 - 2025  Samuel Wang
# 本文件可以根据GNU GPLv3许可协议进行分发
# This file may be distributed under the terms of the GNU GPLv3 license
################################################################################
# Discord: Samuel-0-0#0576    Github: Samuel-0-0    Bilibili: Samuel-0_0
################################################################################
# 文件用途：Touch Probe相关配置
################################################################################
# 根据你的实际情况编辑此文件
################################################################################

######################################################
## Z限位
######################################################
[stepper_z]
### 使用实体Z限位
endstop_pin: M5_STOP                              # 实体Z限位开关PIN脚设置
position_endstop: 1                               # Z轴的机械复位点相对热床的偏移值。正数表示高于热床表面
position_max: 260                                 # Z轴最大行程--软件限位
#position_min: -3                                  # Z轴最小行程，默认0，使用TAP时需要设置负数（-3）
homing_speed: 6                                   # 复位速度，默认5mm/s
homing_retract_speed: 9                           # 触发后的后退速度
second_homing_speed: 3                            # 第二次精确复位的速度
homing_retract_dist: 3                            # 第一次触发复位开关之后的后退距离

######################################################
## Z归零
######################################################
## 下方配置由 _HOME_Z 宏替代
#[safe_z_home]
#home_xy_position: 175,175         # Z轴归零坐标点
#speed: 200.0                      # XY轴移动到Z轴归零坐标点时的运动速度
#z_hop: 5.0                        # Z轴归零操作前抬升高度
#z_hop_speed: 4.0                  # Z轴归零移动速度

[gcode_macro _HOME_Z]
gcode:
    G90
    G1 X229 Y357 F12000           # 移动到Z限位
    G28 Z
    G1 Z5 F1500

######################################################
## 床网
######################################################
[bed_mesh]
speed: 200.0                      # 标定过程中XY移动的速度（以毫米/秒为单位）。默认值为50
horizontal_move_z: 7.0            # 在开始探测操作之前，打印头移动到的高度（以毫米为单位）。默认值为5
mesh_min: 20,20                   # 为矩形床定义网格的最小X、Y坐标。此坐标是相对于探测位置的。这将是离原点最近的第一个被探测的点
mesh_max: 330,330                 # 为矩形床定义网格的最大X、Y坐标。遵循与mesh_min相同的原则，但这将是离床原点最远的被探测的点
probe_count: 7,7                  # 对于矩形床，这是一对以逗号分隔的整数值，定义沿XY轴探测的点的数量。也可以使用单个值，此时该值将应用于两个轴。默认值为3, 3
mesh_pps: 2,2                     # 一个以逗号分隔的整数对，定义沿XY轴在网格中插值的每段的点数。一个“段”可以被定义为每个被探测点之间的空间。也可以使用单个值，此时该值将应用于两个轴。默认值为2, 2
algorithm: bicubic                # 要使用的插值算法。可以是"lagrange"或"bicubic"。此选项不会影响3x3网格(强制使用lagrange)。默认值为lagrange
#zero_reference_position: 175,175  # 指定Z=0位置的可选X、Y坐标。当指定此选项时，网格将被偏移，使得在此位置不会发生Z调整。默认情况下没有零参考
#adaptive_margin: 10               # 生成自适应网格时，在定义的打印对象周围添加的可选边距（以毫米为单位）
#faulty_region_1_min:
#faulty_region_1_max:              # 定义故障区域的可选点。有关故障区域的详细信息，请参阅docs/Bed_Mesh.md。最多可以添加99个故障区域。默认情况下没有设置故障区域

######################################################
## 龙门架调平
######################################################
[quad_gantry_level]
# 350mm机型Z和Z2固定点相对原点位置
gantry_corners:
        -60,-10
        410,420
# 调平采集点坐标
points:
        50,29     #50,25
        50,279    #50,275
        300,279   #300,275
        300,29    #300,25
speed: 300.0                      # 标定过程中XY移动的速度（以毫米/秒为单位）。默认值为50
horizontal_move_z: 5.0            # 在开始探测操作之前，打印头移动到的高度（以毫米为单位）。默认值为5
retries: 5                        # 探测的结果超过retry_tolerance的值，重复采样的次数
retry_tolerance: 0.01             # 如果采样结果的最大值和最小值的差超过此设置，则重试采样
max_adjust: 5.0                   # 采样时Z的最大行程，如果超过这个值还未触发传感器，则停止

######################################################
## 调平传感器
######################################################
# CR-Touch的接口线序为（面朝二维码标签）：GND、5V、探针控制、GND、信号输出
[bltouch]
sensor_pin: ^!tool:TOOL_PROBE
control_pin: tool:TOOL_SERVOS
x_offset: 0                                  # 探针相对喷嘴的偏移数值
y_offset: 21.45                              # 探针相对喷嘴的偏移数值
z_offset: 4                                  # 探针触发时喷嘴与床的距离，必须为正值
speed: 9.0                                   # 校准时Z轴移动速度(mm/s)，默认5
samples: 3                                   # 采样次数
samples_result: median                       # 多次采样使用的结果，median 中位数，average 平均值
sample_retract_dist: 0.5                     # 多次采样时，每次探测完成后打印头抬升的高度(mm)
samples_tolerance: 0.02                      # 多次采样结果对比的最大公差，如果超过此设置就重新进行采样
samples_tolerance_retries: 5                 # 超公差重试次数
pin_up_touch_mode_reports_triggered: False   # 设置 Touch 在连续发送"pin_up"和"touch_mode"后是否持续报告"触发"状态。默认True
probe_with_touch_mode: True                  # 如果为True，那么Klipper将在设备处于"touch_mode"模式下进行探测。默认False
stow_on_each_sample: False                   # 决定 Klipper 在多次探测的序列中每一次探测间是否命令缩回探针。默认True
pin_move_time: 0.9                           # 等待 Touch 引脚向上或向下移动的时间（秒）

######################################################
## 其他需要的宏
######################################################
[gcode_macro Z_AUTOCALIBRATE]
variable_switch_pretravel: 2.85  #2.75              # 探针在Z限位开关处触发与Z限位触发的之间的行程差，值越小喷嘴越靠近床
variable_nozzle_offset: 0
variable_bed_offset: 0
gcode:
    G28 Z
    # 执行多个宏，以便正确填充 printer.probe.last_z_result
    _Z_AUTOCALIBRATE_A
    _Z_AUTOCALIBRATE_B
    _Z_AUTOCALIBRATE_C
    _Z_AUTOCALIBRATE_D

[gcode_macro _Z_AUTOCALIBRATE_A]
gcode:
    # 将Z抬升5mm
    G91
    G0 Z5 F1500
    G90
    # 将探针移动到 Z 端限位开关上方
    G0 X228 Y340 F12000                      # 探针在Z限位开关上方的位置
    PROBE

[gcode_macro _Z_AUTOCALIBRATE_B]
gcode:
    # 保存喷嘴偏移（nozzle_offset）探测结果
    SET_GCODE_VARIABLE MACRO=Z_AUTOCALIBRATE VARIABLE=nozzle_offset VALUE={ printer.probe.last_z_result - printer.configfile.settings.stepper_z.position_endstop }
    # 将探针移动到床中心
    G90
    G0 X175 Y{175 - printer.configfile.settings.bltouch.y_offset} F12000    # 移动到床中心
    PROBE

[gcode_macro _Z_AUTOCALIBRATE_C]
gcode:
    # 保存床偏移（bed_offset）探测结果
    SET_GCODE_VARIABLE MACRO=Z_AUTOCALIBRATE VARIABLE=bed_offset VALUE={ printer.probe.last_z_result }

[gcode_macro _Z_AUTOCALIBRATE_D]
gcode:
    G90
    # 移动到 bed_offset 位置，使喷嘴位于探针平均触发点
    G0 Z{printer["gcode_macro Z_AUTOCALIBRATE"].bed_offset } F1500
    # 此时工具头位于探针触发位置
    # 减去 switch_pretravel，因为探针几乎没有预行程，而喷嘴在实际触发时会稍微远离探针，因此需要补偿。
    # 最后将当前位置设为新的 Z=0
    G92 Z{ printer["gcode_macro Z_AUTOCALIBRATE"].nozzle_offset - printer["gcode_macro Z_AUTOCALIBRATE"].switch_pretravel }

[gcode_macro TOUCH_DOWN]
description: 探针伸出
gcode:
    BLTOUCH_DEBUG COMMAND=pin_down

[gcode_macro TOUCH_UP]
description: 探针缩回
gcode:
    BLTOUCH_DEBUG COMMAND=pin_up

[gcode_macro TOUCH_IT]
description: 探针触发测试
gcode:
    BLTOUCH_DEBUG COMMAND=touch_mode

[gcode_macro TOUCH_TEST]
description: 探针自检
gcode:
    BLTOUCH_DEBUG COMMAND=self_test

[gcode_macro TOUCH_RESET]
description: 探针重置
gcode:
    BLTOUCH_DEBUG COMMAND=reset
