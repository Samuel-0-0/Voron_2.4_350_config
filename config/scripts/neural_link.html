<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>NEURAL LINK</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=JetBrains+Mono:wght@300;500&display=swap" rel="stylesheet">
    <style>
        :root { --neon: #00f3ff; --bg: #01080e; --panel-bg: rgba(0, 20, 30, 0.7); --danger: #ff0055; --success: #00ff41; --warn: #fbb03b; }
        body { background: var(--bg); color: var(--neon); font-family: 'JetBrains Mono', 'Microsoft YaHei', monospace; margin: 0; font-size: 16px; line-height: 1.5; }
        header { padding: 15px 30px; border-bottom: 2px solid var(--neon); font-family: 'Orbitron', sans-serif; display: flex; justify-content: space-between; align-items: center; }
        
        .container { display: grid; grid-template-columns: 280px minmax(600px, 950px); gap: 25px; padding: 25px; justify-content: center; }
        .sidebar { display: flex; flex-direction: column; gap: 18px; border-right: 1px solid rgba(0, 243, 255, 0.1); padding-right: 20px; }
        .main-view { display: flex; flex-direction: column; gap: 20px; }
        
        .panel { display: none; background: var(--panel-bg); border: 1px solid rgba(0, 243, 255, 0.2); padding: 20px; }
        .panel-title { font-family: 'Orbitron', sans-serif; font-size: 17px; margin-bottom: 15px; border-left: 5px solid var(--neon); padding-left: 12px; display: flex; justify-content: space-between; }
        #welcome-panel { display: block; border: 1px dashed var(--neon); text-align: center; padding: 60px 20px; color: rgba(0, 243, 255, 0.6); }

        /* CPU æ ¸å¿ƒè§†å›¾ */
        .cpu-grid { display: flex; gap: 8px; background: rgba(0,0,0,0.4); padding: 15px; border-radius: 4px; border: 1px solid #111; margin-bottom: 15px; }
        .core-slot { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 8px; }
        .bar-bg { width: 100%; height: 8px; background: #000; border-radius: 4px; overflow: hidden; }
        .bar-fill { height: 100%; width: 0%; transition: 0.6s; }
        
        .tag { padding: 4px 12px; border-radius: 2px; font-size: 13px; font-weight: bold; display: inline-block; margin-right: 10px; }
        .tag-ok { border: 1px solid var(--success); color: var(--success); }
        .tag-warn { border: 1px solid var(--warn); color: var(--warn); }

        /* é…ç½®å»ºè®®åŒº */
        .cfg-box { background: rgba(0,0,0,0.6); padding: 20px; margin-top: 15px; border-left: 3px solid var(--neon); font-size: 14px; }
        .cfg-line { margin: 6px 0; color: #ccc; }
        .cfg-val { color: var(--success); font-weight: bold; }
        .cfg-com { color: #555; font-style: italic; margin-left: 10px; }

        /* USB æ ‘å½¢ - å¤‡æ³¨+SN+è¯„åˆ†é€»è¾‘ */
        .tree-node { margin: 8px 0; padding-left: 20px; border-left: 1px dashed rgba(0, 243, 255, 0.2); }
        .node-row { display: flex; align-items: center; gap: 10px; font-size: 14px; }
        .fw-badge { font-size: 11px; padding: 1px 5px; border-radius: 2px; font-weight: bold; color: #000; }
        .fw-KLIPPER { background: var(--success); }
        .fw-KATAPULT { background: var(--warn); }
        .fw-CAN_ADAPTER { background: var(--neon); }
        .fw-DFU { background: var(--danger); }
        .sn-tag { font-size: 12px; color: #666; background: rgba(255,255,255,0.05); padding: 2px 6px; }

        /* eMMC è¿›åº¦æ¡æ ·å¼ */
        .emmc-bar-container { height: 10px; background: #000; margin-top: 10px; border: 1px solid #333; }
        .emmc-bar-fill { height: 100%; width: 0%; background: var(--success); transition: 1s; }

        .btn { background: transparent; border: 1px solid var(--neon); color: var(--neon); padding: 12px; cursor: pointer; font-family: 'Orbitron', sans-serif; font-size: 14px; transition: 0.3s; }
        .btn:hover { background: var(--neon); color: #000; box-shadow: 0 0 15px var(--neon); }
        input, select { background: #000; border: 1px solid var(--neon); color: var(--neon); padding: 12px; outline: none; font-family: inherit; }
        .doc-section { margin-top: 40px; border-top: 1px dashed #333; padding-top: 20px; color: #aaa; }
        .user-mark { color: var(--highlight); color: #ff0000; }
        .log-terminal { background: #000; color: #00ff41; padding: 10px; height: 150px; overflow-y: auto; font-size: 11px; border: 1px solid #222; margin-top: 15px; white-space: pre-wrap; }
        .error-hint { color: var(--danger); font-size: 11px; margin-top: -5px; margin-bottom: 10px; font-weight: bold; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<header>
    <div>NEURAL LINK <span style="font-size: 12px; opacity: 0.5;">v1.0.2 [ POWERED BY SAMUEL.WANG  (ä¸‰æœ¨) ]</span></div>
    <div id="status" style="color:var(--danger)">LINK: OFFLINE</div>
</header>

<div class="container">
    <div class="sidebar">
        <input type="text" id="ip" value="192.168.88.20">
        <button class="btn" onclick="connect()">å»ºç«‹éš§é“è¿æ¥</button>
        <div id="side-err" class="error-hint"></div>
        <button class="btn" onclick="openPanel('cpu')">CPU æ ¸å¿ƒæ£€æŸ¥</button>
        <button class="btn" onclick="openPanel('usb')">USB æ‹“æ‰‘æ£€æŸ¥</button>
        <button class="btn" onclick="openPanel('emmc')">eMMC å¯¿å‘½æ£€æŸ¥</button>
        <button class="btn" onclick="openPanel('can')">CANBus é…ç½®</button>
        <button class="btn" style="border-color:var(--warn); color:var(--warn)" onclick="openPanel('git')">GitHub äº‘å¤‡ä»½</button>
    </div>

    <div class="main-view">
        <div class="panel" id="welcome-panel">
            <div style="font-size: 40px; margin-bottom: 20px;">âš¡</div>
            <div id="welcome-text">è¯·å…ˆå»ºç«‹éš§é“è¿æ¥ï¼Œç„¶åç‚¹å‡»å·¦ä¾§éœ€è¦çš„åŠŸèƒ½</div>
        </div>
        <div class="panel" id="panel-cpu">
            <div class="panel-title"><span>CPU å¼‚æ„æ ¸å¿ƒåˆ†é…è§†å›¾</span><span id="cpu-strat" style="font-size: 12px; opacity: 0.5;">--</span></div>
            <div id="cpu-grid" class="cpu-grid"></div>
            <div id="cpu-model" style="font-size: 18px; color:#fff; margin: 15px 0 10px 0;">ç­‰å¾…æ ¸å¿ƒæ•°æ®...</div>
            <div id="cpu-audit">
                <div id="tag-aff" class="tag">äº²å’Œåº¦: --</div>
                <div id="tag-nice" class="tag">ä¼˜å…ˆçº§: --</div>
            </div>
            <div id="cpu-guide" style="display:none;">
                <div style="color:var(--warn); font-size: 14px; margin-top:15px; font-weight:bold;">âš¡ è°ƒåº¦å»ºè®®ï¼šKlipper æ ¸å¿ƒæœåŠ¡åº”é”å®šåœ¨é«˜æ€§èƒ½æ ¸å¿ƒä¸Š</div>
                <div class="cfg-box">
                    <div class="cfg-line">â— /etc/systemd/system/klipper.service</div>
                    <div class="cfg-line" style="padding-left:20px;">[Service]</div>
                    <div class="cfg-line" style="padding-left:20px;"><span class="cfg-val">CPUAffinity=<span id="cfg-aff-val"></span></span> <span class="cfg-com"># ç»‘å®šè‡³è¯†åˆ«çš„å¤§æ ¸</span></div>
                    <div class="cfg-line" style="padding-left:20px;"><span class="cfg-val">Nice=-20</span> <span class="cfg-com"># æŠ¢å å¼ä¼˜å…ˆçº§</span></div>
                    <div class="cfg-line" style="margin-top:10px;">â— moonraker.service / crowsnest.service</div>
                    <div class="cfg-line" style="padding-left:20px;"><span class="cfg-val">CPUAffinity=<span id="cfg-other-val"></span></span> <span class="cfg-com"># ç§»è‡³èƒ½æ•ˆæ ¸ï¼Œé¿å…å¹²æ‰°</span></div>
                </div>
            </div>
        </div>

        <div class="panel" id="panel-usb">
            <div class="panel-title"><span>USB é€šè®¯é“¾æ‹“æ‰‘</span></div>
            <div id="usb-tree">ç­‰å¾…æŒ‡ä»¤...</div>
        </div>

        <div class="panel" id="panel-emmc">
            <div class="panel-title"><span>eMMC å­˜å‚¨å¥åº·çŠ¶æ€</span></div>
            <div style="display:flex; justify-content:space-between; font-size:14px;"><span>èŠ¯ç‰‡é¢„ä¼°å¯¿å‘½</span><span id="emmc-pct">--</span></div>
            <div class="emmc-bar-container"><div id="emmc-fill" class="emmc-bar-fill"></div></div>
            <div id="emmc-msg" style="margin-top:10px; font-size:12px; color:#666;">--</div>
        </div>
        <div class="panel" id="panel-can">
            <div class="panel-title">CANBus è‡ªåŠ¨åŒ–ç¯å¢ƒé…ç½®</div>
            <div id="can-status-box" style="font-size:12px; margin-bottom:15px; border:1px dashed var(--neon); padding:10px;"></div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                <div>
                    <label for="can-pwd" style="font-size:11px;">ROOT å¯†ç  (Sudo):</label>
                    <input type="password" id="can-pwd" placeholder="å†™å…¥é…ç½®å¿…éœ€">
                    <div id="pwd-err" class="error-hint"></div>
                </div>
                <div>
                    <label for="can-ifname" style="font-size:11px;">CAN æ¥å£åç§°:</label>
                    <input type="text" id="can-ifname" value="can0">
                </div>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                <div>
                    <label for="can-br" style="font-size:11px;">Bitrate (bps):</label>
                    <select id="can-br"><option value="1000000">1000000 (1M)</option><option value="500000">500000 (500K)</option></select>
                </div>
                <div>
                    <label for="can-tx" style="font-size:11px;">txqueuelen:</label>
                    <select id="can-tx"><option value="1024">1024 (æ— è„‘ä½¿ç”¨)</option><option value="512">512 (å‡å°‘TTC)</option><option value="256">256 (ç¤¾åŒºæ¨è)</option><option value="128">128 (Klipperå»ºè®®å€¼)</option></select>
                </div>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
                <button class="btn" onclick="applyCan()">[ ä¿å­˜é…ç½® ]</button>
                <button class="btn" style="border-color:var(--warn); color:var(--warn);" onclick="restartCan()">[ é‡å¯ç½‘ç»œ ]</button>
            </div>
            <div class="log-terminal" id="can-terminal">ç»ˆç«¯å°±ç»ª</div>
        </div>
        <div class="panel" id="panel-git">
            <div class="panel-title"><span>GitHub é…ç½®äº‘åŒæ­¥å¤‡ä»½</span></div>
            <div style="font-size:13px; color:#888; margin-bottom:15px;">
                æ­¤æ“ä½œå°†å¤‡ä»½ <span style="color:var(--neon)">~/printer_data</span> ç›®å½•è‡³å…³è”çš„è¿œç¨‹ä»“åº“ã€‚å¤‡ä»½è¯´æ˜ä¼šè‡ªåŠ¨é™„å¸¦ Klipper/Moonraker ç‰ˆæœ¬å·ã€‚
            </div>
            <div style="display:flex; gap:10px;">
                <input type="text" id="git-msg" placeholder="è¾“å…¥æ›´æ–°è¯´æ˜ (é»˜è®¤: Web Auto Backup)" style="flex:1">
                <button class="btn" style="border-color:var(--success); color:var(--success)" onclick="startBackup()">[ ç«‹å³æ‰§è¡Œå¤‡ä»½ ]</button>
            </div>
            <div class="log-terminal" id="git-terminal">ç»ˆç«¯å°±ç»ªï¼Œç­‰å¾…æŒ‡ä»¤...</div>
            <div class="doc-section">
                <p>(æ³¨æ„ï¼šä»¥ä¸‹æ–¹æ³•ä¸­å·²æ ‡è®°<span class="user-mark">çº¢è‰²</span>çš„ä»£ç æ®µéœ€æ›¿æ¢ä¸ºä½ è‡ªå·±çš„ä¿¡æ¯)</p>
                <details>
                    <summary>í ½í³˜ GitHub SSH å¯†é’¥é…ç½®æŒ‡å— (åˆæ¬¡ä½¿ç”¨å¿…çœ‹)</summary>
                    <p>1. ç»ˆç«¯æ‰§è¡Œé…ç½®å¹¶ç”Ÿæˆ Key:</p>
                    <div class="code-block">
                        git config --global user.name "<span class="user-mark">Samuel Wang</span>" && \<br>
                        git config --global user.email "<span class="user-mark">imhsaw@gmail.com</span>" && \<br>
                        ssh-keygen -t rsa -C "<span class="user-mark">imhsaw@gmail.com</span>" && \<br>
                        cat ~/.ssh/id_rsa.pub
                    </div>
                    <p>2. å¤åˆ¶ä¸Šæ–¹æ‰“å°çš„å†…å®¹ã€‚<br>å‰å¾€ GitHub -> Settings -> SSH and GPG keys -> New SSH Keyï¼Œç²˜è´´å¹¶ä¿å­˜ã€‚</p>
                </details>

                <details>
                    <summary>í ½í» ï¸ ç¬¬ä¸€æ¬¡å¤‡ä»½</summary>
                    <p>1. åˆå§‹åŒ–æ–‡ä»¶å¤¹ï¼ˆä»¥å‰æ²¡æœ‰åšè¿‡Gitå¤‡ä»½ï¼‰:</p>
                    <div class="code-block">
                        cd ~/printer_data && git init && \<br>
                        git branch -m main && \<br>
                        git remote add origin git@github.com:<span class="user-mark">Samuel-0-0/Voron_2.4_350_config</span>.git
                    </div>
                    <p>2. å¯¼å…¥è¯ä¹¦:</p>
                    <div class="code-block">
                        cd ~/printer_data && ssh -T git@github.com
                    </div>
                    <p>3. æ‰‹åŠ¨æ‰§è¡Œä¸€æ¬¡å¤‡ä»½:</p>
                    <div class="code-block">
                        1ï¼‰git add . -v<br>
                        2ï¼‰git commit -m "first commit"<br>
                        3ï¼‰git push -u origin main<br>
                    </div>
                </details>

                <details>
                    <summary>í ½í²¾ æ–°ç³»ç»Ÿæ¢å¤ä¸è¿ç§»é…ç½®ï¼ˆå·²ç»æœ‰è¿œç¨‹å¤‡ä»½æ—¶ï¼‰</summary>
                    <p>1. æ¢å¤å¤‡ä»½çš„ SSH å¯†é’¥åæ‰§è¡Œæƒé™ä¿®æ­£:</p>
                    <div class="code-block">chmod 600 ~/.ssh/id_rsa && chmod 644 ~/.ssh/id_rsa.pub</div>
                    <p>2. å…‹éš†é…ç½®å¹¶é‡æ–°å…³è”:</p>
                    <div class="code-block">
                        1ï¼‰git clone https://github.com/<span class="user-mark">Samuel-0-0/voron_350_klipper_config</span>.git ~/printer_data<br>
                        2ï¼‰git config --global user.name "<span class="user-mark">Samuel Wang</span>" && git config --global user.email "<span class="user-mark">imhsaw@gmail.com</span>"<br>
                        3ï¼‰cd ~/printer_data && git remote set-url origin git@github.com:<span class="user-mark">Samuel-0-0/Voron_2.4_350_config</span>.git && ssh -T git@github.com
                    </div>
                </details>
            </div>
        </div>
    </div>
</div>

<script>
    let ws;
    const sideErr = document.getElementById('side-err');
    function connect() {
        const ip = document.getElementById('ip').value;
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        ws = new WebSocket(`${protocol}//${ip}:1111/ws`);
        ws.onopen = () => { document.getElementById('status').innerText = "LINK: ONLINE"; document.getElementById('status').style.color = "var(--success)"; sideErr.innerText = ""; return;};
        ws.onmessage = (e) => handleData(JSON.parse(e.data));
    }
    function openPanel(name) {
        if(!ws || ws.readyState !== 1) { sideErr.innerText = "è¯·å…ˆè¿æ¥éš§é“"; return; }
        document.querySelectorAll('.panel').forEach(p => p.style.display = 'none');
        document.getElementById('panel-' + name).style.display = 'block';
        if(name === 'can') ws.send(JSON.stringify({action: 'can_status'}));
        else ws.send(JSON.stringify({action: name}));
    }
    function startBackup() {
        const msg = document.getElementById('git-msg').value || "Web Auto Backup";
        document.getElementById('git-terminal').innerHTML = `[${new Date().toLocaleTimeString()}] æ­£åœ¨åˆå§‹åŒ– Git å¤‡ä»½æµç¨‹...`;
        ws.send(JSON.stringify({action: 'git_backup', params: { msg }}));
    }
    function applyCan() {
        const pwd = document.getElementById('can-pwd').value;
        if(!pwd) { document.getElementById('pwd-err').innerText = "éœ€è¦ Root æˆæƒ"; return; }
        document.getElementById('pwd-err').innerText = "";
        ws.send(JSON.stringify({action: 'can_apply', params: {
            pwd, ifname: document.getElementById('can-ifname').value, 
            bitrate: document.getElementById('can-br').value, txlen: document.getElementById('can-tx').value
        }}));
    }

    function restartCan() {
        const pwd = document.getElementById('can-pwd').value;
        if(!pwd) { document.getElementById('pwd-err').innerText = "éœ€è¦ Root æˆæƒ"; return; }
        ws.send(JSON.stringify({action: 'can_restart', params: { pwd }}));
    }

    function handleData(res) {
        if(res.type === 'cpu') {
            const d = res.data;
            document.getElementById('cpu-model').innerText = d.model;
            document.getElementById('cpu-strat').innerText = `æ¶æ„æ¨¡å¼: ${d.strategy}`;
            document.getElementById('cpu-grid').innerHTML = d.usage.map((val, i) => {
                const isBig = d.big_cores.includes(i);
                return `<div class="core-slot">
                    <div style="font-size:14px; font-weight:bold; color:${isBig?'var(--neon)':'#a020f0'}">${val}%</div>
                    <div class="bar-bg"><div class="bar-fill" style="width:${val}%; background:${isBig?'var(--neon)':'#a020f0'}"></div></div>
                    <div style="font-size:11px; opacity:0.5;">Core ${i}</div>
                </div>`;
            }).join('');
            document.getElementById('tag-aff').innerText = `äº²å’Œåº¦: ${d.config.affinity}`;
            document.getElementById('tag-aff').className = 'tag ' + (d.config.affinity !== 'æœªè®¾ç½®' ? 'tag-ok' : 'tag-warn');
            document.getElementById('tag-nice').innerText = `è°ƒåº¦ä¼˜å…ˆçº§: ${d.config.nice}`;
            document.getElementById('tag-nice').className = 'tag ' + (d.config.nice === '-20' ? 'tag-ok' : 'tag-warn');
            document.getElementById('cfg-aff-val').innerText = d.recommend.klipper;
            document.getElementById('cfg-other-val').innerText = d.recommend.other;
            document.getElementById('cpu-guide').style.display = d.config.is_optimized ? 'none' : 'block';
        }

        if(res.type === 'emmc') {
            document.getElementById('emmc-pct').innerText = res.data.mlc + "%";
            document.getElementById('emmc-fill').style.width = res.data.mlc + "%";
            document.getElementById('emmc-msg').innerText = `èŠ‚ç‚¹: ${res.data.device} | ${res.data.msg}`;
        }

        if(res.type === 'usb') {
            const buildTree = (nodes, pid) => {
                return nodes.filter(n => n.pid === pid).map(n => `
                    <div class="tree-node">
                        <div class="node-row">
                            <span style="border:1px solid var(--neon); font-size:10px; padding:0 4px;">${n.type}</span>
                            <span>${n.name}</span>
                            ${n.fw.map(tag => `<span class="fw-badge fw-${tag}">${tag.replace('_', ' ')}</span>`).join('')}
                            ${n.serial !== 'N/A' ? `<span class="sn-tag">SN: ${n.serial}</span>` : ''}
                            <span style="margin-left:auto; color:${n.score>85?'var(--success)':'var(--danger)'}">${n.score}åˆ†</span>
                        </div>
                        ${buildTree(nodes, n.id)}
                    </div>`).join('');
            };
            document.getElementById('usb-tree').innerHTML = buildTree(res.data.nodes, "1-0");
        }
        if(res.type === 'can_status') {
            document.getElementById('can-status-box').innerHTML = `ç®¡ç†æ¨¡å¼: ${res.data.mode} | å†…æ ¸æ¨¡å—: ${res.data.kernel_can}<br>æ¥å£çŠ¶æ€: ${res.data.interfaces}`;
        }
        if(res.type === 'can_log') {
            const term = document.getElementById('can-terminal');
            term.innerHTML += `\n[${new Date().toLocaleTimeString()}] ${res.data}`;
            term.scrollTop = term.scrollHeight;
        }
        if(res.type === 'git_log') {
            const term = document.getElementById('git-terminal');
            term.innerHTML += `\n[${new Date().toLocaleTimeString()}] ${res.data}`;
            term.scrollTop = term.scrollHeight;
        }
    }
</script>
</body>
</html>